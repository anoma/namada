# Localnet genesis templates using hardware wallet keys

This directory contains genesis templates for a local network with a single validator. The `src` directory contains generated pre-genesis wallet pre-loaded with public keys, derivation paths, and a single validator `validator-0` wallet that are being used in the templates. Most of the keys for this network are derived from a hardware wallet configured with a specific seed phrase.

If you're modifying any of the files here, you can run this to ensure that the changes are valid:

```shell
cargo watch -x "test test_validate_hardware_genesis_templates"
```

## Reproducibility

To ensure that the key generated by the hardware wallet for a given derivation path is always the same, the hardware wallet must be configured to use a known test mnemonic. Specifically, these genesis templates were generated using the following test mnemonic: `equip will roof matter pink blind book anxiety banner elbow sun young`. Instructions on how to configure the hardware wallet with this mnemonic can be found in the `Set a test mnemonic` section of <https://github.com/Zondax/ledger-namada?tab=readme-ov-file#how-to-prepare-your-development-device>.
## E2E and Integration Tests
The E2E and integration tests can be made to use these hardware wallet based genesis templates by setting the environment variable `NAMADA_E2E_USE_DEVICE` to `true` when running `make test ...`. In order to ensure the success of these tests, please ensure that the following requirements are met:
* The hardware wallet is connected and the Ledger app is open for the duration of the E2E tests
* Transactions are promptly manually approved on the hardware wallet before the E2E test timeouts ellapse
* The hardware wallet is configured with the same test mnemonic used to generate these genesis templates. See [reproducibility](#reproducibility).

### Using Ledger emulator Speculos

1. Build an elf file of the Namada ledger app <https://github.com/Zondax/ledger-namada>
2. Build the emulator following the instructions from <https://speculos.ledger.com/>
3. Start the emulator with:
  ```sh
  ./speculos.py ../ledger-namada/app/output/app_s2.elf --seed "equip will roof matter pink blind book anxiety banner elbow sun young"
  ```
4. Set env var `export NAMADA_DEVICE_TRANSPORT=tcp` to connect to the emulator. The default ip/port is `127.0.0.1:9999`. To use a different ip/port set `LEDGER_PROXY_ADDRESS` and/or `LEDGER_PROXY_PORT`, respectively.

## pre-genesis/wallet.toml

The pre-genesis balances wallet is located at [pre-genesis/wallet.toml](pre-genesis/wallet.toml) and can be re-generated from the repo's root dir with:

```shell
cargo run --bin namadaw -- --base-dir "genesis/hardware/src" derive \
  --alias albert-key --pre-genesis --use-device --hd-path "m/44'/877'/0'/0'/0'"
cargo run --bin namadaw -- --base-dir "genesis/hardware/src" derive \
  --alias bertha-key --pre-genesis --use-device --hd-path "m/44'/877'/0'/0'/1'"
cargo run --bin namadaw -- --base-dir "genesis/hardware/src" derive \
  --alias christel --pre-genesis --use-device --hd-path "m/44'/877'/0'/0'/2'"
cargo run --bin namadaw -- --base-dir "genesis/hardware/src" derive \
  --alias daewon --pre-genesis --use-device --hd-path "m/44'/877'/0'/0'/3'"
cargo run --bin namadaw -- --base-dir "genesis/hardware/src" derive \
  --alias validator-0-account-key --pre-genesis --use-device --hd-path "m/44'/877'/0'/0'/5'"
cargo run --bin namadaw -- --base-dir "genesis/hardware/src" gen \
  --alias faucet-key --unsafe-dont-encrypt --pre-genesis
```

Some keys are used to setup established accounts and some are directly assigned balances in the [balances.toml](#balancestoml) file to implicit addresses derived from these keys.

## transactions.toml

### Transaction to initialize an established account

For example, Albert's account is created with:

```shell
cargo run --bin namadac -- --base-dir "genesis/localnet/src" utils \
  init-genesis-established-account \
  --path "genesis/localnet/src/pre-genesis/established/established-account-tx-albert.toml" \
  --aliases "albert-key"
```

Note that the command will print out your `Derived established account address`.

### Validator transactions

To create a validator's account, first initialize an established account:

```shell
cargo run --bin namadac -- --base-dir "genesis/localnet/src" utils \
  init-genesis-established-account \
  --path "genesis/localnet/src/pre-genesis/validator-0/unsigned-transactions.toml" \
  --aliases "validator-0-account-key"
```

The `Derived established account address` and the transaction added to the TOML file from this command is used in the following command.

The pre-genesis validator wallet used to generate [validator transactions for transactions.toml](src/pre-genesis/validator-0/transactions.toml) is located at [src/pre-genesis/validator-0/validator-wallet.toml](src/pre-genesis/validator-0/validator-wallet.toml) and can be re-generated:

```shell
cargo run --bin namadac -- --base-dir "genesis/localnet/src" utils \
  init-genesis-validator \
  --alias validator-0 \
  --address tnam1q9vhfdur7gadtwx4r223agpal0fvlqhywylf2mzx \
  --path "genesis/localnet/src/pre-genesis/validator-0/unsigned-transactions.toml" \
  --net-address "127.0.0.1:27656" \
  --commission-rate 0.05 \
  --max-commission-rate-change 0.01 \
  --email "null@null.net" \
  --self-bond-amount 100000 \
  --unsafe-dont-encrypt
```

### Delegations

A delegation with e.g. 20 000 NAM tokens to a validator account whose address has to be known beforehand (here the validator-0 created above) is created with:

```shell
cargo run --bin namadac -- --base-dir "genesis/localnet/src" utils \
  genesis-bond \
  --validator tnam1q9vhfdur7gadtwx4r223agpal0fvlqhywylf2mzx \
  --amount 20000 \
  --path "genesis/localnet/src/pre-genesis/bond/bond-tx-albert.toml"
```

### Signing

The non-validator transactions are manually appended together in [src/pre-genesis/unsigned-transactions.toml](src/pre-genesis/unsigned-transactions.toml) and then signed to produce [src/pre-genesis/signed-transactions.toml](src/pre-genesis/signed-transactions.toml) using:

```shell
cargo run --bin namadac -- --base-dir "genesis/localnet/src" utils \
  sign-genesis-txs --use-device \
  --path "genesis/localnet/src/pre-genesis/unsigned-transactions.toml" \
  --output "genesis/localnet/src/pre-genesis/signed-transactions.toml"
```

The validator transactions are signed using (note the extra `--alias` argument needed to find the validator pre-genesis wallet):

```shell
cargo run --bin namadac -- --base-dir "genesis/localnet/src" utils \
  sign-genesis-txs --use-device \
  --path "genesis/localnet/src/pre-genesis/validator-0/unsigned-transactions.toml" \
  --output "genesis/localnet/src/pre-genesis/validator-0/signed-transactions.toml" \
  --alias validator-0
```

This non-validator [src/pre-genesis/signed-transactions.toml](src/pre-genesis/signed-transactions.toml) are joined together with [src/validator-0/signed-transactions.toml](src/validator-0/signed-transactions.toml) in [transactions.toml](transactions.toml).

## balances.toml

The [balances.toml file](balances.toml) contains token balances associated with public keys or established addresses which can be derived from genesis transactions. The public keys from the wallet can be found with:

```shell
cargo run --bin namadaw -- --base-dir "genesis/localnet/src" key list
```

If you didn't note the address from your transactions, you can deterministically derive an established address from the TOML file again, run with the `--path` set to a transaction TOML file:

```shell
cargo run --bin namadac -- --base-dir "genesis/localnet/src" utils \
  derive-genesis-addresses \
  --path "genesis/localnet/src/pre-genesis/established/established-account-tx-validator-0.toml"
```

## Validation

A unit test `test_validate_hardware_genesis_templates` is setup to check validity of the localnet setup.
